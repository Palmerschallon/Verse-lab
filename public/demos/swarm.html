<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>swarm — verse</title>
<style>
  :root{
    --bg:#000; --fg:#fff;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);
    font:14px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  canvas{position:fixed;inset:0;display:block;background:#000}
  .hint{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
    color:#9aa0a6;letter-spacing:.2px;opacity:.85;pointer-events:none;
    text-align:center;user-select:none}
  .fade{animation:fade 2.3s both} @keyframes fade{0%{opacity:.9}90%{opacity:.45}100%{opacity:0}}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="hint" class="hint fade">tap to pause · paste to reseed<br/><span style="opacity:.7">?seed=“many… ring” or ?count=800</span></div>

<script>
/* ----------------- tiny deterministic RNG ----------------- */
function xmur3(str){let h=1779033703^str.length;for(let i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=h<<13|h>>>19}
  return ()=>{h=Math.imul(h^h>>>16,2246822507);h=Math.imul(h^h>>>13,3266489909);return (h^=h>>>16)>>>0}}
function mulberry32(a){return()=>{let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}

/* ----------------- canvas & DPR fit ----------------- */
const canvas = document.getElementById('c'), ctx = canvas.getContext('2d',{alpha:false});
function fit(){const dpr=Math.max(1,Math.min(3,devicePixelRatio||1));
  canvas.width=Math.floor(innerWidth*dpr);canvas.height=Math.floor(innerHeight*dpr);
  canvas.style.width=innerWidth+'px';canvas.style.height=innerHeight+'px';
  ctx.setTransform(dpr,0,0,dpr,0,0)}
addEventListener('resize',fit,{passive:true}); fit();

/* ----------------- params from seed ----------------- */
function parseSeed(text){
  const s=(text||'').toLowerCase();
  // count
  let count = 400;
  if(/\b(zero|null|silence|void)\b/.test(s)) count=0;
  else if(/\b(one|solo|single)\b/.test(s)) count=1;
  else if(/\b(few)\b/.test(s)) count=120;
  else if(/\b(some|several)\b/.test(s)) count=300;
  else if(/\b(many|legion)\b/.test(s)) count=800;
  else if(/\b(thousand|thousands)\b/.test(s)) count=1600;
  const m = s.match(/\b(\d{1,5})\b/); if(m) count = Math.max(0,Math.min(8000,+m[1]));

  // field “shape”
  let shape = 'none';
  if(/\b(ring|circle|torus|halo)\b/.test(s)) shape='ring';
  else if(/\b(lattice|grid|weave)\b/.test(s)) shape='lattice';
  else if(/\b(wave|sine|ripple)\b/.test(s)) shape='wave';
  else if(/\b(spiral|galaxy|vortex)\b/.test(s)) shape='spiral';

  // motion adjectives
  const tremor =
    /\b(calm|still)\b/.test(s) ? 0.12 :
    /\b(wild|restless)\b/.test(s) ? 1.0  : 0.45;
  const tide =
    /\b(slow)\b/.test(s) ? 0.1 :
    /\b(fast|rush|wind)\b/.test(s) ? 0.9 : 0.45;

  // trails
  const trails =
    /\b(ghost|long)\b/.test(s) ? 0.96 :
    /\b(short)\b/.test(s) ? 0.80 : 0.90;

  return {count, shape, tremor, tide, trails};
}

/* ----------------- world state ----------------- */
const state={
  seed:'', rng:mulberry32(1), t:0, paused:false,
  params:{count:0,shape:'none',tremor:0.4,tide:0.5,trails:0.9},
  parts:[], samples:null
};
function rnd(){return state.rng();}
function reseed(text){
  state.seed=(text||'').slice(0,2000);
  const h=xmur3(state.seed||('rand-'+Math.random())); state.rng=mulberry32(h());
  state.params=parseSeed(state.seed);
  spawn(state.params.count);
}
function spawn(n){
  state.parts.length=0;
  for(let i=0;i<n;i++){
    state.parts.push({
      x:rnd()*innerWidth, y:rnd()*innerHeight,
      vx:(rnd()*2-1)*0.4, vy:(rnd()*2-1)*0.4, id:i
    });
  }
}

/* ----------------- fields ----------------- */
function shapeSamples(name){
  const cx=innerWidth/2, cy=innerHeight/2, R=Math.min(innerWidth,innerHeight)*0.34;
  const N=360, pts=[];
  if(name==='ring'){
    for(let i=0;i<N;i++){const a=2*Math.PI*(i/N);pts.push({x:cx+R*Math.cos(a),y:cy+R*Math.sin(a)})}
  }else if(name==='lattice'){
    const step=Math.max(18,R*0.20); for(let y=cy-R;y<=cy+R;y+=step) for(let x=cx-R;x<=cx+R;x+=step) pts.push({x,y});
  }else if(name==='wave'){
    const A=R*0.33, k=2; for(let i=0;i<N;i++){const t=i/N;const x=(innerWidth*0.12)+t*(innerWidth*0.76);pts.push({x, y:cy+A*Math.sin(2*Math.PI*k*t)})}
  }else if(name==='spiral'){
    const turns=2.2; for(let i=0;i<N;i++){const t=i/N; const a=2*Math.PI*turns*t, r=R*0.1+R*0.9*t; pts.push({x:cx+r*Math.cos(a), y:cy+r*Math.sin(a)})}
  }
  return pts;
}
function field(ax,ay,p){
  // slow global rotation (tide)
  const t=state.t*(0.0006+state.params.tide*0.0013), c=Math.cos(t), s=Math.sin(t);
  let fx=ax*c - ay*s, fy=ax*s + ay*c;

  // jitter (tremor) — stable per id
  const n = (Math.sin((p.id*12.9898 + state.t*0.015)*43758.5453)%1);
  fx += (n*2-1)*state.params.tremor*0.6;
  fy += ((1-n*1.7)%1*2-1)*state.params.tremor*0.6;

  // optional shape attraction
  if(state.params.shape !== 'none'){
    if(!state.samples || state.samples.name!==state.params.shape){
      state.samples = {name:state.params.shape, pts:shapeSamples(state.params.shape)};
    }
    const pts=state.samples.pts; if(pts.length){
      // nearest point (subsampled)
      let bestDx=0,bestDy=0,best=Infinity;
      for(let i=0;i<pts.length;i+=3){const s=pts[i]; const dx=s.x-p.x, dy=s.y-p.y, d=dx*dx+dy*dy; if(d<best){best=d;bestDx=dx;bestDy=dy}}
      const pull = 0.0009 + 0.0014*(1-Math.min(1,best/(innerWidth*innerHeight)));
      fx += bestDx*pull; fy += bestDy*pull;
    }
  }
  return {fx,fy};
}

/* ----------------- main loop ----------------- */
function tick(){
  if(!state.paused) state.t+=16;

  // trails/fade
  ctx.globalCompositeOperation='source-over';
  ctx.fillStyle=`rgba(0,0,0,${1-state.params.trails})`;
  ctx.fillRect(0,0,innerWidth,innerHeight);

  // draw particles
  if(state.parts.length){
    ctx.globalCompositeOperation='lighter';
    ctx.strokeStyle='rgba(255,255,255,.9)';
    ctx.lineWidth=1;
    ctx.beginPath();
    for(const p of state.parts){
      const f=field(p.vx,p.vy,p);
      p.vx = p.vx*0.96 + f.fx*0.6;
      p.vy = p.vy*0.96 + f.fy*0.6;
      const nx=p.x+p.vx, ny=p.y+p.vy;
      ctx.moveTo(p.x,p.y); ctx.lineTo(nx,ny);
      p.x=nx; p.y=ny;
      if(p.x<0) p.x+=innerWidth; if(p.x>innerWidth) p.x-=innerWidth;
      if(p.y<0) p.y+=innerHeight; if(p.y>innerHeight) p.y-=innerHeight;
    }
    ctx.stroke();
  }

  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);

/* ----------------- interactions ----------------- */
// tap pause/resume
let downAt=0;
addEventListener('pointerdown',()=>{downAt=performance.now()},{passive:true});
addEventListener('pointerup',()=>{
  const dt=performance.now()-downAt;
  if(dt<220){ state.paused=!state.paused; }
  else { /* long press */ state.t=0; } // soft reset
},{passive:true});

// paste applies as seed
addEventListener('paste', e=>{
  const t=(e.clipboardData||window.clipboardData).getData('text');
  if(t){ reseed(t.trim()); document.getElementById('hint').style.display='none'; }
});

/* ----------------- boot from URL ----------------- */
const q = new URLSearchParams(location.search);
const seed = q.get('seed');
const explicitCount = q.get('count');
if(explicitCount){
  reseed(String(explicitCount));
}else if(seed){
  reseed(seed);
}else{
  // pleasant default
  reseed('many embers gather to ring; calm; long trails');
  setTimeout(()=>document.getElementById('hint').style.display='none', 2000);
}
</script>
</body>
</html>
